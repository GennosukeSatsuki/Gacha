name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: generate_notes
        run: |
          cat > instructions.md << EOF
          # Idea Mixer v${{ steps.get_version.outputs.version }} ğŸš€

          ## ğŸ“¦ Downloads / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          Please download the file for your platform:
          ãŠä½¿ã„ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š

          - **Windows**: \`idea_mixer-windows-x64.zip\`
          - **macOS**: \`idea_mixer-macos.dmg\`
          - **Android**: \`idea_mixer-android.apk\`

          ## ğŸ“ How to Install / ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          ### Windows
          1. Download the ZIP file. / ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Extract it and run the executable. / è§£å‡ã—ã¦å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·å‹•

          ### macOS
          1. Download the DMG file. / DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Double-click to mount. / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ
          3. Drag the app to the Applications folder. / ã‚¢ãƒ—ãƒªã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã¸ãƒ‰ãƒ©ãƒƒã‚°
          4. Right-click and select "Open" for the first time. / åˆå›ã¯å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œé–‹ãã€

          ### Android
          1. Download the APK file. / APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Enable "Unknown sources" in settings. / è¨­å®šã‹ã‚‰æä¾›å…ƒä¸æ˜ã®ã‚¢ãƒ—ãƒªã‚’è¨±å¯
          3. Tap the APK to install. / APKã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

          ---
          ## ğŸ”„ What's Changed / å¤‰æ›´ç‚¹
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: v${{ steps.get_version.outputs.version }}
          body_path: instructions.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows archive
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath idea_mixer-windows-x64.zip

      - name: Upload Windows Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: idea_mixer-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS
        run: |
          flutter build macos --release

      - name: Create DMG
        run: |
          # Install create-dmg if not available
          brew install create-dmg || true
          
          # Create a temporary directory for DMG contents
          mkdir -p dmg_temp
          cp -R build/macos/Build/Products/Release/*.app dmg_temp/
          
          # Get the app name from the folder
          APP_NAME=$(ls dmg_temp | grep .app)
          
          # Create DMG
          create-dmg \
            --volname "Idea Mixer" \
            --volicon "macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_512.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME" 175 190 \
            --hide-extension "$APP_NAME" \
            --app-drop-link 425 190 \
            "idea_mixer-macos.dmg" \
            "dmg_temp/" || \
          hdiutil create -volname "Idea Mixer" -srcfolder dmg_temp -ov -format UDZO "idea_mixer-macos.dmg"

      - name: Upload macOS Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: idea_mixer-macos.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk idea_mixer-android.apk

      - name: Upload Android Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: idea_mixer-android.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Social Media
    needs: [create-release, build-windows, build-macos, build-android]
    runs-on: ubuntu-latest
    env:
      HAS_TWITTER: ${{ secrets.TWITTER_CONSUMER_API_KEY != '' }}
    steps:
      - name: Send Tweet
        # Only run if Twitter secrets are configured
        if: env.HAS_TWITTER == 'true'
        continue-on-error: true
        uses: smapiot/send-tweet-v2-action@v1
        with:
          status: |
            Idea Mixer v${{ needs.create-release.outputs.version }} ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸï¼ ğŸš€
            å‰µä½œã®ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆºæ¿€ã™ã‚‹ã‚¬ãƒãƒ£å½¢å¼ã®ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§ã™ã€‚è‡ªä½œã‚«ãƒ¼ãƒ‰ä½œæˆæ©Ÿèƒ½ (Studio) ã‚„ç”»åƒåˆ‡ã‚ŠæŠœãæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸå¤§å‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ğŸ¨âœ‚ï¸

            Idea Mixer v${{ needs.create-release.outputs.version }} is out! ğŸš€
            A gacha-style idea generator to spark your creative inspiration. This major update adds the "Studio" feature and an image cropper! ğŸ¨âœ‚ï¸

            Download here:
            https://github.com/${{ github.repository }}/releases/tag/v${{ needs.create-release.outputs.version }}

            #IdeaMixer #Flutter #Gacha #IndieDev #WritingCommunity #å‰µä½œã‚¯ãƒ©ã‚¹ã‚¿
          consumer-key: ${{ secrets.TWITTER_CONSUMER_API_KEY }}
          consumer-secret: ${{ secrets.TWITTER_CONSUMER_API_SECRET }}
          access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
