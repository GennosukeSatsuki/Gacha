name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: generate_notes
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Generate changelog
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # Create release notes
          cat > release_notes.md << EOF
          # ã‚¢ã‚¤ãƒ‡ã‚¢ãƒŸã‚­ã‚µãƒ¼ v${{ steps.get_version.outputs.version }}
          
          ## ðŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          ãŠä½¿ã„ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š
          
          - **Windows**: \`plot_mixer-windows-x64.zip\`
          - **macOS (Apple Silicon)**: \`plot_mixer-macos-arm64.dmg\`
          - **macOS (Intel)**: \`plot_mixer-macos-x64.dmg\`
          - **Android**: \`plot_mixer-android.apk\`
          
          ## ðŸ”„ å¤‰æ›´å†…å®¹
          
          ${CHANGELOG}
          
          ## ðŸ“ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          
          ### Windows
          1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. è§£å‡ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·å‹•
          
          ### macOS
          1. DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒžã‚¦ãƒ³ãƒˆ
          3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°
          4. åˆå›žèµ·å‹•æ™‚ã¯å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œé–‹ãã€ã§å®Ÿè¡Œ
          
          ### Android
          1. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. æä¾›å…ƒä¸æ˜Žã®ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¨±å¯
          3. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${{ steps.get_version.outputs.version }}
          EOF
          
          cat release_notes.md

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows archive
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath plot_mixer-windows-x64.zip

      - name: Upload Windows Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./plot_mixer-windows-x64.zip
          asset_name: plot_mixer-windows-x64.zip
          asset_content_type: application/zip

  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            flutter_arch: arm64
          - arch: x64
            flutter_arch: x86_64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS (${{ matrix.arch }})
        run: |
          flutter build macos --release --target-platform darwin-${{ matrix.flutter_arch }}

      - name: Create DMG
        run: |
          # Install create-dmg if not available
          brew install create-dmg || true
          
          # Create a temporary directory for DMG contents
          mkdir -p dmg_temp
          cp -R build/macos/Build/Products/Release/plot_mixer.app dmg_temp/
          
          # Create DMG
          create-dmg \
            --volname "Plot Mixer" \
            --volicon "macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_512.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "plot_mixer.app" 175 190 \
            --hide-extension "plot_mixer.app" \
            --app-drop-link 425 190 \
            "plot_mixer-macos-${{ matrix.arch }}.dmg" \
            "dmg_temp/" || \
          hdiutil create -volname "Plot Mixer" -srcfolder dmg_temp -ov -format UDZO "plot_mixer-macos-${{ matrix.arch }}.dmg"

      - name: Upload macOS Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./plot_mixer-macos-${{ matrix.arch }}.dmg
          asset_name: plot_mixer-macos-${{ matrix.arch }}.dmg
          asset_content_type: application/x-apple-diskimage

  build-android:
    name: Build Android
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk plot_mixer-android.apk

      - name: Upload Android Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./plot_mixer-android.apk
          asset_name: plot_mixer-android.apk
          asset_content_type: application/vnd.android.package-archive
